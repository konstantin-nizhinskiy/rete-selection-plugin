{"version":3,"file":"rete-selection-plugin.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { NodeEditor } from 'rete'\n\ndeclare module 'rete/types/events' {\n  interface EventsTypes {\n    multiselection: boolean;\n  }\n}\n\nexport interface Cfg {\n  selectionArea?: {\n    className?: string;\n  };\n  enabled?: boolean;\n  mode?: [string, string];\n}\n\nexport interface Position {\n  x: number;\n  y: number;\n}\n\nexport interface Size {\n  width: number;\n  height: number;\n}\n\nconst MOUSE_LEFT_BUTTON = 0\n\nfunction drawSelectionArea(area: HTMLDivElement, position: Position, size: Size) {\n  area.style.left = `${position.x}px`\n  area.style.top = `${position.y}px`\n  area.style.width = `${size.width}px`\n  area.style.height = `${size.height}px`\n  area.style.opacity = '0.2'\n}\n\nfunction cleanSelectionArea(area: HTMLDivElement) {\n  area.style.left = '0px'\n  area.style.top = '0px'\n  area.style.width = '0px'\n  area.style.height = '0px'\n  area.style.opacity = '0'\n}\n\nfunction applyTransform(translateX: number, translateY: number, scale: number, position: Position): Position {\n  return {\n    x: (position.x - translateX) / scale,\n    y: (position.y - translateY) / scale\n  }\n}\n\nfunction install(editor: NodeEditor, params: Cfg) {\n  editor.bind('multiselection')\n\n  const cfg = params ?? {}\n\n  // #region Статус плагина\n  let accumulate = false\n  let pressing = false\n  const selection: [Position, Position] = [{ x: 0, y: 0 }, { x: 0, y: 0 }]\n  // #endregion\n\n  // Объект холста\n  const canvas = editor.view.container.firstElementChild as HTMLDivElement\n\n  // #region Получить узлы в диапазоне выбора кадра\n  const getNodesFromSelectionArea = () => {\n    if (!cfg.enabled) {\n      return []\n    }\n\n    const { x: translateX, y: translateY, k: scale } = editor.view.area.transform\n    const areaStart = applyTransform(translateX, translateY, scale, { ...selection[0] })\n    const areaEnd = applyTransform(translateX, translateY, scale, { ...selection[1] })\n\n    // Отрегулируйте порядок точек\n    if (areaEnd.x < areaStart.x) {\n      const num = areaStart.x\n      areaStart.x = areaEnd.x\n      areaEnd.x = num\n    }\n    if (areaEnd.y < areaStart.y) {\n      const num = areaStart.y\n      areaStart.y = areaEnd.y\n      areaEnd.y = num\n    }\n\n    return editor.nodes.filter(item => {\n      const [x, y] = item.position\n      return (x >= areaStart.x && x <= areaEnd.x && y >= areaStart.y && y <= areaEnd.y)\n    })\n  }\n  // #endregion\n\n  // #region Создать выбор\n  const selectionArea = document.createElement('div')\n  selectionArea.classList.add('selection-area')\n  selectionArea.style.position = 'absolute'\n  selectionArea.style.boxSizing = 'border-box'\n  selectionArea.style.pointerEvents = 'none'\n  cleanSelectionArea(selectionArea)\n\n\n  // #region Настройка внешнего вида\n  {\n    const className = cfg.selectionArea?.className\n    if (className) {\n      selectionArea.classList.add(...className.split(' '))\n    } else {\n      selectionArea.style.backgroundColor = '#E3F2FD'\n      selectionArea.style.border = 'solid 1px #42A5F5'\n      selectionArea.style.borderRadius = '4px'\n    }\n  }\n  // #endregion\n\n  // #region Выберите мероприятие\n  const handleMouseDown = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (!cfg.enabled) {\n      return\n    }\n\n    if (e.button !== MOUSE_LEFT_BUTTON) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n\n    pressing = true\n\n    // Защищайте события мыши от других элементов\n    canvas.style.pointerEvents = 'none'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'none'\n    })\n\n    // Инициализировать связанное состояние\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: e.offsetX, y: e.offsetY }\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n  }\n\n  const handleMouseUp = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    const selectedNodes = getNodesFromSelectionArea()\n\n    pressing = false\n\n    // Восстановить события мыши других элементов\n    canvas.style.pointerEvents = 'auto'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'auto'\n    })\n\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: 0, y: 0 }\n    selection[1] = { x: 0, y: 0 }\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n\n    selectedNodes.forEach((node) => {\n      editor.selectNode(node, accumulate)\n    })\n  }\n\n  const handleMouseMove = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n    if (!pressing) {\n      return\n    }\n  /*  if (editor.selected.list.length > 0) {\n      return\n    }*/\n\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n\n    const size: Size = {\n      width: Math.abs(selection[1].x - selection[0].x),\n      height: Math.abs(selection[1].y - selection[0].y)\n    }\n    const position = { ...selection[0] }\n\n    if (selection[1].x < selection[0].x) {\n      position.x = selection[1].x\n    }\n    if (selection[1].y < selection[0].y) {\n      position.y = selection[1].y\n    }\n\n    // Если какой-либо узел не выбран, необходимо нарисовать диапазон выбора кадра.\n    drawSelectionArea(selectionArea, position, size)\n  }\n  // #endregion\n\n  // #region Инициализировать стили и события\n  editor.view.container.style.position = 'relative'\n  editor.view.container.appendChild(selectionArea)\n\n  editor.view.container.addEventListener('mousedown', handleMouseDown)\n  editor.view.container.addEventListener('mouseup', handleMouseUp)\n  editor.view.container.addEventListener('mouseout', handleMouseUp)\n  editor.view.container.addEventListener('mousemove', handleMouseMove)\n\n  editor.on('destroy', () => {\n    editor.view.container.removeChild(selectionArea)\n\n\n    editor.view.container.removeEventListener('mousedown', handleMouseDown)\n    editor.view.container.removeEventListener('mouseup', handleMouseUp)\n    editor.view.container.removeEventListener('mouseout', handleMouseUp)\n    editor.view.container.removeEventListener('mousemove', handleMouseMove)\n  })\n\n  editor.on('multiselection', enabled => {\n    cfg.enabled = enabled\n  })\n\n  editor.on('keydown', (e) => {\n    if (e.ctrlKey) {\n      accumulate = true\n      editor.view.container.classList.add(\"multi-select\")\n    }\n  })\n\n  editor.on('keyup', () => {\n    if (accumulate) {\n      accumulate = false\n      editor.view.container.classList.remove(\"multi-select\")\n    }\n  })\n\n  editor.on('translate', () => {\n    return !accumulate\n  })\n  // #endregion\n}\n\nexport default {\n  name: 'rete-selection-plugin',\n  install\n}\n"],"names":["MOUSE_LEFT_BUTTON","drawSelectionArea","area","position","size","style","left","x","top","y","width","height","opacity","cleanSelectionArea","applyTransform","translateX","translateY","scale","install","editor","params","bind","cfg","accumulate","pressing","selection","canvas","view","container","firstElementChild","getNodesFromSelectionArea","enabled","transform","k","areaStart","areaEnd","num","nodes","filter","item","selectionArea","document","createElement","classList","add","boxSizing","pointerEvents","className","split","backgroundColor","border","borderRadius","handleMouseDown","e","preventDefault","stopPropagation","button","ctrlKey","Array","from","querySelectorAll","forEach","offsetX","offsetY","handleMouseUp","selectedNodes","node","selectNode","handleMouseMove","Math","abs","appendChild","addEventListener","on","removeChild","removeEventListener","remove","name"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0BA,IAAMA,iBAAiB,GAAG,CAA1B;;AAEA,SAASC,iBAAT,CAA2BC,IAA3B,EAAiDC,QAAjD,EAAqEC,IAArE,EAAiF;EAC/EF,IAAI,CAACG,KAAL,CAAWC,IAAX,aAAqBH,QAAQ,CAACI,CAA9B;EACAL,IAAI,CAACG,KAAL,CAAWG,GAAX,aAAoBL,QAAQ,CAACM,CAA7B;EACAP,IAAI,CAACG,KAAL,CAAWK,KAAX,aAAsBN,IAAI,CAACM,KAA3B;EACAR,IAAI,CAACG,KAAL,CAAWM,MAAX,aAAuBP,IAAI,CAACO,MAA5B;EACAT,IAAI,CAACG,KAAL,CAAWO,OAAX,GAAqB,KAArB;;;AAGF,SAASC,kBAAT,CAA4BX,IAA5B,EAAkD;EAChDA,IAAI,CAACG,KAAL,CAAWC,IAAX,GAAkB,KAAlB;EACAJ,IAAI,CAACG,KAAL,CAAWG,GAAX,GAAiB,KAAjB;EACAN,IAAI,CAACG,KAAL,CAAWK,KAAX,GAAmB,KAAnB;EACAR,IAAI,CAACG,KAAL,CAAWM,MAAX,GAAoB,KAApB;EACAT,IAAI,CAACG,KAAL,CAAWO,OAAX,GAAqB,GAArB;;;AAGF,SAASE,cAAT,CAAwBC,UAAxB,EAA4CC,UAA5C,EAAgEC,KAAhE,EAA+Ed,QAA/E,EAA6G;SACpG;IACLI,CAAC,EAAE,CAACJ,QAAQ,CAACI,CAAT,GAAaQ,UAAd,IAA4BE,KAD1B;IAELR,CAAC,EAAE,CAACN,QAAQ,CAACM,CAAT,GAAaO,UAAd,IAA4BC;GAFjC;;;AAMF,SAASC,OAAT,CAAiBC,MAAjB,EAAqCC,MAArC,EAAkD;EAChDD,MAAM,CAACE,IAAP,CAAY,gBAAZ;MAEMC,GAAG,GAAGF,MAAH,aAAGA,MAAH,cAAGA,MAAH,GAAa,EAAtB,CAHgD;;MAM5CG,UAAU,GAAG,KAAjB;MACIC,QAAQ,GAAG,KAAf;MACMC,SAA+B,GAAG,CAAC;IAAElB,CAAC,EAAE,CAAL;IAAQE,CAAC,EAAE;GAAZ,EAAiB;IAAEF,CAAC,EAAE,CAAL;IAAQE,CAAC,EAAE;GAA5B,CAAxC,CARgD;;;MAY1CiB,MAAM,GAAGP,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsBC,iBAArC,CAZgD;;MAe1CC,yBAAyB,GAAG,SAA5BA,yBAA4B,GAAM;QAClC,CAACR,GAAG,CAACS,OAAT,EAAkB;aACT,EAAP;;;gCAGiDZ,MAAM,CAACQ,IAAP,CAAYzB,IAAZ,CAAiB8B,SAL9B;QAK3BjB,UAL2B,yBAK9BR,CAL8B;QAKZS,UALY,yBAKfP,CALe;QAKGQ,KALH,yBAKAgB,CALA;QAMhCC,SAAS,GAAGpB,cAAc,CAACC,UAAD,EAAaC,UAAb,EAAyBC,KAAzB,oBAAqCQ,SAAS,CAAC,CAAD,CAA9C,EAAhC;QACMU,OAAO,GAAGrB,cAAc,CAACC,UAAD,EAAaC,UAAb,EAAyBC,KAAzB,oBAAqCQ,SAAS,CAAC,CAAD,CAA9C,EAA9B,CAPsC;;QAUlCU,OAAO,CAAC5B,CAAR,GAAY2B,SAAS,CAAC3B,CAA1B,EAA6B;UACrB6B,GAAG,GAAGF,SAAS,CAAC3B,CAAtB;MACA2B,SAAS,CAAC3B,CAAV,GAAc4B,OAAO,CAAC5B,CAAtB;MACA4B,OAAO,CAAC5B,CAAR,GAAY6B,GAAZ;;;QAEED,OAAO,CAAC1B,CAAR,GAAYyB,SAAS,CAACzB,CAA1B,EAA6B;UACrB2B,IAAG,GAAGF,SAAS,CAACzB,CAAtB;MACAyB,SAAS,CAACzB,CAAV,GAAc0B,OAAO,CAAC1B,CAAtB;MACA0B,OAAO,CAAC1B,CAAR,GAAY2B,IAAZ;;;WAGKjB,MAAM,CAACkB,KAAP,CAAaC,MAAb,CAAoB,UAAAC,IAAI,EAAI;0CAClBA,IAAI,CAACpC,QADa;UAC1BI,CAD0B;UACvBE,CADuB;;aAEzBF,CAAC,IAAI2B,SAAS,CAAC3B,CAAf,IAAoBA,CAAC,IAAI4B,OAAO,CAAC5B,CAAjC,IAAsCE,CAAC,IAAIyB,SAAS,CAACzB,CAArD,IAA0DA,CAAC,IAAI0B,OAAO,CAAC1B,CAA/E;KAFK,CAAP;GArBF,CAfgD;;;;MA4C1C+B,aAAa,GAAGC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAAtB;EACAF,aAAa,CAACG,SAAd,CAAwBC,GAAxB,CAA4B,gBAA5B;EACAJ,aAAa,CAACnC,KAAd,CAAoBF,QAApB,GAA+B,UAA/B;EACAqC,aAAa,CAACnC,KAAd,CAAoBwC,SAApB,GAAgC,YAAhC;EACAL,aAAa,CAACnC,KAAd,CAAoByC,aAApB,GAAoC,MAApC;EACAjC,kBAAkB,CAAC2B,aAAD,CAAlB,CAjDgD;;;;;QAsDxCO,SAAS,yBAAGzB,GAAG,CAACkB,aAAP,uDAAG,mBAAmBO,SAArC;;QACIA,SAAJ,EAAe;;;+BACbP,aAAa,CAACG,SAAd,EAAwBC,GAAxB,iDAA+BG,SAAS,CAACC,KAAV,CAAgB,GAAhB,CAA/B;KADF,MAEO;MACLR,aAAa,CAACnC,KAAd,CAAoB4C,eAApB,GAAsC,SAAtC;MACAT,aAAa,CAACnC,KAAd,CAAoB6C,MAApB,GAA6B,mBAA7B;MACAV,aAAa,CAACnC,KAAd,CAAoB8C,YAApB,GAAmC,KAAnC;;GA5D4C;;;MAkE1CC,eAAe,GAAG,SAAlBA,eAAkB,CAACC,CAAD,EAAmB;IACzCA,CAAC,CAACC,cAAF;IACAD,CAAC,CAACE,eAAF;;QAEI,CAACjC,GAAG,CAACS,OAAT,EAAkB;;;;QAIdsB,CAAC,CAACG,MAAF,KAAaxD,iBAAjB,EAAoC;;;;QAGhC,CAACqD,CAAC,CAACI,OAAP,EAAgB;;;;IAIhBjC,QAAQ,GAAG,IAAX,CAfyC;;IAkBzCE,MAAM,CAACrB,KAAP,CAAayC,aAAb,GAA6B,MAA7B;IACAY,KAAK,CAACC,IAAN,CAAWjC,MAAM,CAACkC,gBAAP,CAAwB,MAAxB,CAAX,EAA4CC,OAA5C,CAAoD,UAAAtB,IAAI,EAAI;MACzDA,IAAD,CAAqBlC,KAArB,CAA2ByC,aAA3B,GAA2C,MAA3C;KADF,EAnByC;;IAwBzCjC,kBAAkB,CAAC2B,aAAD,CAAlB;IACAf,SAAS,CAAC,CAAD,CAAT,GAAe;MAAElB,CAAC,EAAE8C,CAAC,CAACS,OAAP;MAAgBrD,CAAC,EAAE4C,CAAC,CAACU;KAApC;IACAtC,SAAS,CAAC,CAAD,CAAT,GAAe;MAAElB,CAAC,EAAE8C,CAAC,CAACS,OAAP;MAAgBrD,CAAC,EAAE4C,CAAC,CAACU;KAApC;GA1BF;;MA6BMC,aAAa,GAAG,SAAhBA,aAAgB,CAACX,CAAD,EAAmB;IACvCA,CAAC,CAACC,cAAF;IACAD,CAAC,CAACE,eAAF;QAEMU,aAAa,GAAGnC,yBAAyB,EAA/C;IAEAN,QAAQ,GAAG,KAAX,CANuC;;IASvCE,MAAM,CAACrB,KAAP,CAAayC,aAAb,GAA6B,MAA7B;IACAY,KAAK,CAACC,IAAN,CAAWjC,MAAM,CAACkC,gBAAP,CAAwB,MAAxB,CAAX,EAA4CC,OAA5C,CAAoD,UAAAtB,IAAI,EAAI;MACzDA,IAAD,CAAqBlC,KAArB,CAA2ByC,aAA3B,GAA2C,MAA3C;KADF;IAIAjC,kBAAkB,CAAC2B,aAAD,CAAlB;IACAf,SAAS,CAAC,CAAD,CAAT,GAAe;MAAElB,CAAC,EAAE,CAAL;MAAQE,CAAC,EAAE;KAA1B;IACAgB,SAAS,CAAC,CAAD,CAAT,GAAe;MAAElB,CAAC,EAAE,CAAL;MAAQE,CAAC,EAAE;KAA1B;;QAEI,CAACa,GAAG,CAACS,OAAT,EAAkB;;;;QAGd,CAACsB,CAAC,CAACI,OAAP,EAAgB;;;;IAIhBQ,aAAa,CAACJ,OAAd,CAAsB,UAACK,IAAD,EAAU;MAC9B/C,MAAM,CAACgD,UAAP,CAAkBD,IAAlB,EAAwB3C,UAAxB;KADF;GAzBF;;MA8BM6C,eAAe,GAAG,SAAlBA,eAAkB,CAACf,CAAD,EAAmB;IACzCA,CAAC,CAACC,cAAF;IACAD,CAAC,CAACE,eAAF;;QAEI,CAACjC,GAAG,CAACS,OAAT,EAAkB;;;;QAGd,CAACsB,CAAC,CAACI,OAAP,EAAgB;;;;QAGZ,CAACjC,QAAL,EAAe;;;;;;;;IAOfC,SAAS,CAAC,CAAD,CAAT,GAAe;MAAElB,CAAC,EAAE8C,CAAC,CAACS,OAAP;MAAgBrD,CAAC,EAAE4C,CAAC,CAACU;KAApC;QAEM3D,IAAU,GAAG;MACjBM,KAAK,EAAE2D,IAAI,CAACC,GAAL,CAAS7C,SAAS,CAAC,CAAD,CAAT,CAAalB,CAAb,GAAiBkB,SAAS,CAAC,CAAD,CAAT,CAAalB,CAAvC,CADU;MAEjBI,MAAM,EAAE0D,IAAI,CAACC,GAAL,CAAS7C,SAAS,CAAC,CAAD,CAAT,CAAahB,CAAb,GAAiBgB,SAAS,CAAC,CAAD,CAAT,CAAahB,CAAvC;KAFV;;QAIMN,QAAQ,qBAAQsB,SAAS,CAAC,CAAD,CAAjB,CAAd;;QAEIA,SAAS,CAAC,CAAD,CAAT,CAAalB,CAAb,GAAiBkB,SAAS,CAAC,CAAD,CAAT,CAAalB,CAAlC,EAAqC;MACnCJ,QAAQ,CAACI,CAAT,GAAakB,SAAS,CAAC,CAAD,CAAT,CAAalB,CAA1B;;;QAEEkB,SAAS,CAAC,CAAD,CAAT,CAAahB,CAAb,GAAiBgB,SAAS,CAAC,CAAD,CAAT,CAAahB,CAAlC,EAAqC;MACnCN,QAAQ,CAACM,CAAT,GAAagB,SAAS,CAAC,CAAD,CAAT,CAAahB,CAA1B;KA7BuC;;;IAiCzCR,iBAAiB,CAACuC,aAAD,EAAgBrC,QAAhB,EAA0BC,IAA1B,CAAjB;GAjCF,CA7HgD;;;;EAmKhDe,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsBvB,KAAtB,CAA4BF,QAA5B,GAAuC,UAAvC;EACAgB,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB2C,WAAtB,CAAkC/B,aAAlC;EAEArB,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB4C,gBAAtB,CAAuC,WAAvC,EAAoDpB,eAApD;EACAjC,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB4C,gBAAtB,CAAuC,SAAvC,EAAkDR,aAAlD;EACA7C,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB4C,gBAAtB,CAAuC,UAAvC,EAAmDR,aAAnD;EACA7C,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB4C,gBAAtB,CAAuC,WAAvC,EAAoDJ,eAApD;EAEAjD,MAAM,CAACsD,EAAP,CAAU,SAAV,EAAqB,YAAM;IACzBtD,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB8C,WAAtB,CAAkClC,aAAlC;IAGArB,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB+C,mBAAtB,CAA0C,WAA1C,EAAuDvB,eAAvD;IACAjC,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB+C,mBAAtB,CAA0C,SAA1C,EAAqDX,aAArD;IACA7C,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB+C,mBAAtB,CAA0C,UAA1C,EAAsDX,aAAtD;IACA7C,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsB+C,mBAAtB,CAA0C,WAA1C,EAAuDP,eAAvD;GAPF;EAUAjD,MAAM,CAACsD,EAAP,CAAU,gBAAV,EAA4B,UAAA1C,OAAO,EAAI;IACrCT,GAAG,CAACS,OAAJ,GAAcA,OAAd;GADF;EAIAZ,MAAM,CAACsD,EAAP,CAAU,SAAV,EAAqB,UAACpB,CAAD,EAAO;QACtBA,CAAC,CAACI,OAAN,EAAe;MACblC,UAAU,GAAG,IAAb;MACAJ,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsBe,SAAtB,CAAgCC,GAAhC,CAAoC,cAApC;;GAHJ;EAOAzB,MAAM,CAACsD,EAAP,CAAU,OAAV,EAAmB,YAAM;QACnBlD,UAAJ,EAAgB;MACdA,UAAU,GAAG,KAAb;MACAJ,MAAM,CAACQ,IAAP,CAAYC,SAAZ,CAAsBe,SAAtB,CAAgCiC,MAAhC,CAAuC,cAAvC;;GAHJ;EAOAzD,MAAM,CAACsD,EAAP,CAAU,WAAV,EAAuB,YAAM;WACpB,CAAClD,UAAR;GADF,EAvMgD;;;AA6MlD,YAAe;EACbsD,IAAI,EAAE,uBADO;EAEb3D,OAAO,EAAPA;CAFF;;;;"}