{"version":3,"file":"rete-selection-plugin.min.js","sources":["../src/index.ts"],"sourcesContent":["import { NodeEditor } from 'rete'\n\ndeclare module 'rete/types/events' {\n  interface EventsTypes {\n    multiselection: boolean;\n  }\n}\n\nexport interface Cfg {\n  selectionArea?: {\n    className?: string;\n  };\n  enabled?: boolean;\n  mode?: [string, string];\n}\n\nexport interface Position {\n  x: number;\n  y: number;\n}\n\nexport interface Size {\n  width: number;\n  height: number;\n}\n\nconst MOUSE_LEFT_BUTTON = 0\n\nfunction drawSelectionArea(area: HTMLDivElement, position: Position, size: Size) {\n  area.style.left = `${position.x}px`\n  area.style.top = `${position.y}px`\n  area.style.width = `${size.width}px`\n  area.style.height = `${size.height}px`\n  area.style.opacity = '0.2'\n}\n\nfunction cleanSelectionArea(area: HTMLDivElement) {\n  area.style.left = '0px'\n  area.style.top = '0px'\n  area.style.width = '0px'\n  area.style.height = '0px'\n  area.style.opacity = '0'\n}\n\nfunction applyTransform(translateX: number, translateY: number, scale: number, position: Position): Position {\n  return {\n    x: (position.x - translateX) / scale,\n    y: (position.y - translateY) / scale\n  }\n}\n\nfunction install(editor: NodeEditor, params: Cfg) {\n  editor.bind('multiselection')\n\n  const cfg = params ?? {}\n\n  // #region Статус плагина\n  let accumulate = false\n  let pressing = false\n  const selection: [Position, Position] = [{ x: 0, y: 0 }, { x: 0, y: 0 }]\n  // #endregion\n\n  // Объект холста\n  const canvas = editor.view.container.firstElementChild as HTMLDivElement\n\n  // #region Получить узлы в диапазоне выбора кадра\n  const getNodesFromSelectionArea = () => {\n    if (!cfg.enabled) {\n      return []\n    }\n\n    const { x: translateX, y: translateY, k: scale } = editor.view.area.transform\n    const areaStart = applyTransform(translateX, translateY, scale, { ...selection[0] })\n    const areaEnd = applyTransform(translateX, translateY, scale, { ...selection[1] })\n\n    // Отрегулируйте порядок точек\n    if (areaEnd.x < areaStart.x) {\n      const num = areaStart.x\n      areaStart.x = areaEnd.x\n      areaEnd.x = num\n    }\n    if (areaEnd.y < areaStart.y) {\n      const num = areaStart.y\n      areaStart.y = areaEnd.y\n      areaEnd.y = num\n    }\n\n    return editor.nodes.filter(item => {\n      const [x, y] = item.position\n      return (x >= areaStart.x && x <= areaEnd.x && y >= areaStart.y && y <= areaEnd.y)\n    })\n  }\n  // #endregion\n\n  // #region Создать выбор\n  const selectionArea = document.createElement('div')\n  selectionArea.classList.add('selection-area')\n  selectionArea.style.position = 'absolute'\n  selectionArea.style.boxSizing = 'border-box'\n  selectionArea.style.pointerEvents = 'none'\n  cleanSelectionArea(selectionArea)\n\n\n  // #region Настройка внешнего вида\n  {\n    const className = cfg.selectionArea?.className\n    if (className) {\n      selectionArea.classList.add(...className.split(' '))\n    } else {\n      selectionArea.style.backgroundColor = '#E3F2FD'\n      selectionArea.style.border = 'solid 1px #42A5F5'\n      selectionArea.style.borderRadius = '4px'\n    }\n  }\n  // #endregion\n\n  // #region Выберите мероприятие\n  const handleMouseDown = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (!cfg.enabled) {\n      return\n    }\n\n    if (e.button !== MOUSE_LEFT_BUTTON) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n\n    pressing = true\n\n    // Защищайте события мыши от других элементов\n    canvas.style.pointerEvents = 'none'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'none'\n    })\n\n    // Инициализировать связанное состояние\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: e.offsetX, y: e.offsetY }\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n  }\n\n  const handleMouseUp = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    const selectedNodes = getNodesFromSelectionArea()\n\n    pressing = false\n\n    // Восстановить события мыши других элементов\n    canvas.style.pointerEvents = 'auto'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'auto'\n    })\n\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: 0, y: 0 }\n    selection[1] = { x: 0, y: 0 }\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n\n    selectedNodes.forEach((node) => {\n      editor.selectNode(node, accumulate)\n    })\n  }\n\n  const handleMouseMove = (e: MouseEvent) => {\n    e.preventDefault()\n    e.stopPropagation()\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n    if (!pressing) {\n      return\n    }\n  /*  if (editor.selected.list.length > 0) {\n      return\n    }*/\n\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n\n    const size: Size = {\n      width: Math.abs(selection[1].x - selection[0].x),\n      height: Math.abs(selection[1].y - selection[0].y)\n    }\n    const position = { ...selection[0] }\n\n    if (selection[1].x < selection[0].x) {\n      position.x = selection[1].x\n    }\n    if (selection[1].y < selection[0].y) {\n      position.y = selection[1].y\n    }\n\n    // Если какой-либо узел не выбран, необходимо нарисовать диапазон выбора кадра.\n    drawSelectionArea(selectionArea, position, size)\n  }\n  // #endregion\n\n  // #region Инициализировать стили и события\n  editor.view.container.style.position = 'relative'\n  editor.view.container.appendChild(selectionArea)\n\n  editor.view.container.addEventListener('mousedown', handleMouseDown)\n  editor.view.container.addEventListener('mouseup', handleMouseUp)\n  editor.view.container.addEventListener('mouseout', handleMouseUp)\n  editor.view.container.addEventListener('mousemove', handleMouseMove)\n\n  editor.on('destroy', () => {\n    editor.view.container.removeChild(selectionArea)\n\n\n    editor.view.container.removeEventListener('mousedown', handleMouseDown)\n    editor.view.container.removeEventListener('mouseup', handleMouseUp)\n    editor.view.container.removeEventListener('mouseout', handleMouseUp)\n    editor.view.container.removeEventListener('mousemove', handleMouseMove)\n  })\n\n  editor.on('multiselection', enabled => {\n    cfg.enabled = enabled\n  })\n\n  editor.on('keydown', (e) => {\n    if (e.ctrlKey) {\n      accumulate = true\n      editor.view.container.classList.add(\"multi-select\")\n    }\n  })\n\n  editor.on('keyup', () => {\n    if (accumulate) {\n      accumulate = false\n      editor.view.container.classList.remove(\"multi-select\")\n    }\n  })\n\n  editor.on('translate', () => {\n    return !accumulate\n  })\n  // #endregion\n}\n\nexport default {\n  name: 'rete-selection-plugin',\n  install\n}\n"],"names":["cleanSelectionArea","area","style","left","top","width","height","opacity","applyTransform","translateX","translateY","scale","position","x","y","name","install","editor","params","bind","cfg","accumulate","pressing","selection","canvas","view","container","firstElementChild","selectionArea","document","createElement","handleMouseDown","e","preventDefault","stopPropagation","enabled","button","ctrlKey","pointerEvents","Array","from","querySelectorAll","forEach","item","offsetX","offsetY","handleMouseUp","selectedNodes","num","transform","k","areaStart","areaEnd","nodes","filter","getNodesFromSelectionArea","node","selectNode","handleMouseMove","size","Math","abs","classList","add","boxSizing","className","_cfg$selectionArea","split","backgroundColor","border","borderRadius","appendChild","addEventListener","on","removeChild","removeEventListener","remove"],"mappings":"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"}