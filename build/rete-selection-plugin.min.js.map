{"version":3,"file":"rete-selection-plugin.min.js","sources":["../src/index.ts"],"sourcesContent":["import { NodeEditor } from 'rete'\n\ndeclare module 'rete/types/events' {\n  interface EventsTypes {\n    multiselection: boolean;\n  }\n}\n\nexport interface Cfg {\n  selectionArea?: {\n    className?: string;\n  };\n  enabled?: boolean;\n  mode?: [string, string];\n}\n\nexport interface Position {\n  x: number;\n  y: number;\n}\n\nexport interface Size {\n  width: number;\n  height: number;\n}\n\nconst MOUSE_LEFT_BUTTON = 0\n\nfunction drawSelectionArea(area: HTMLDivElement, position: Position, size: Size) {\n  area.style.left = `${position.x}px`\n  area.style.top = `${position.y}px`\n  area.style.width = `${size.width}px`\n  area.style.height = `${size.height}px`\n  area.style.opacity = '0.2'\n}\n\nfunction cleanSelectionArea(area: HTMLDivElement) {\n  area.style.left = '0px'\n  area.style.top = '0px'\n  area.style.width = '0px'\n  area.style.height = '0px'\n  area.style.opacity = '0'\n}\n\nfunction applyTransform(translateX: number, translateY: number, scale: number, position: Position): Position {\n  return {\n    x: (position.x - translateX) / scale,\n    y: (position.y - translateY) / scale\n  }\n}\n\nfunction install(editor: NodeEditor, params: Cfg) {\n  editor.bind('multiselection')\n\n  const cfg = params ?? {}\n\n  // #region Статус плагина\n  let accumulate = false\n  let pressing = false\n  const selection: [Position, Position] = [{ x: 0, y: 0 }, { x: 0, y: 0 }]\n  // #endregion\n\n  // Объект холста\n  const canvas = editor.view.container.firstElementChild as HTMLDivElement\n\n  // #region Получить узлы в диапазоне выбора кадра\n  const getNodesFromSelectionArea = () => {\n    if (!cfg.enabled) {\n      return []\n    }\n\n    const { x: translateX, y: translateY, k: scale } = editor.view.area.transform\n    const areaStart = applyTransform(translateX, translateY, scale, { ...selection[0] })\n    const areaEnd = applyTransform(translateX, translateY, scale, { ...selection[1] })\n\n    // Отрегулируйте порядок точек\n    if (areaEnd.x < areaStart.x) {\n      const num = areaStart.x\n      areaStart.x = areaEnd.x\n      areaEnd.x = num\n    }\n    if (areaEnd.y < areaStart.y) {\n      const num = areaStart.y\n      areaStart.y = areaEnd.y\n      areaEnd.y = num\n    }\n\n    return editor.nodes.filter(item => {\n      const [x, y] = item.position\n      return (x >= areaStart.x && x <= areaEnd.x && y >= areaStart.y && y <= areaEnd.y)\n    })\n  }\n  // #endregion\n\n  // #region Создать выбор\n  const selectionArea = document.createElement('div')\n  selectionArea.classList.add('selection-area')\n  selectionArea.style.position = 'absolute'\n  selectionArea.style.boxSizing = 'border-box'\n  selectionArea.style.pointerEvents = 'none'\n  cleanSelectionArea(selectionArea)\n\n\n  // #region Настройка внешнего вида\n  {\n    const className = cfg.selectionArea?.className\n    if (className) {\n      selectionArea.classList.add(...className.split(' '))\n    } else {\n      selectionArea.style.backgroundColor = '#E3F2FD'\n      selectionArea.style.border = 'solid 1px #42A5F5'\n      selectionArea.style.borderRadius = '4px'\n    }\n  }\n  // #endregion\n\n  // #region Выберите мероприятие\n  const handleMouseDown = (e: MouseEvent) => {\n/*    e.preventDefault()\n    e.stopPropagation()*/\n\n    if (!cfg.enabled) {\n      return\n    }\n\n    if (e.button !== MOUSE_LEFT_BUTTON) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n    if (editor.selected.list.length > 0) {\n      return\n    }\n\n    pressing = true\n\n    // Защищайте события мыши от других элементов\n    canvas.style.pointerEvents = 'none'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'none'\n    })\n\n    // Инициализировать связанное состояние\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: e.offsetX, y: e.offsetY }\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n  }\n\n  const handleMouseUp = (e: MouseEvent) => {\n/*    e.preventDefault()\n    e.stopPropagation()*/\n\n    const selectedNodes = getNodesFromSelectionArea()\n\n    pressing = false\n\n    // Восстановить события мыши других элементов\n    canvas.style.pointerEvents = 'auto'\n    Array.from(canvas.querySelectorAll('path')).forEach(item => {\n      (item as SVGElement).style.pointerEvents = 'auto'\n    })\n\n    cleanSelectionArea(selectionArea)\n    selection[0] = { x: 0, y: 0 }\n    selection[1] = { x: 0, y: 0 }\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n\n    selectedNodes.forEach((node) => {\n      editor.selectNode(node, accumulate)\n    })\n  }\n\n  const handleMouseMove = (e: MouseEvent) => {\n /*   e.preventDefault()\n    e.stopPropagation()*/\n\n    if (!cfg.enabled) {\n      return\n    }\n    if (!e.ctrlKey) {\n      return\n    }\n    if (!pressing) {\n      return\n    }\n    if (editor.selected.list.length > 0) {\n      return\n    }\n\n    selection[1] = { x: e.offsetX, y: e.offsetY }\n\n    const size: Size = {\n      width: Math.abs(selection[1].x - selection[0].x),\n      height: Math.abs(selection[1].y - selection[0].y)\n    }\n    const position = { ...selection[0] }\n\n    if (selection[1].x < selection[0].x) {\n      position.x = selection[1].x\n    }\n    if (selection[1].y < selection[0].y) {\n      position.y = selection[1].y\n    }\n\n    // Если какой-либо узел не выбран, необходимо нарисовать диапазон выбора кадра.\n    drawSelectionArea(selectionArea, position, size)\n  }\n  // #endregion\n\n  // #region Инициализировать стили и события\n  editor.view.container.style.position = 'relative'\n  editor.view.container.appendChild(selectionArea)\n\n  editor.view.container.addEventListener('mousedown', handleMouseDown)\n  editor.view.container.addEventListener('mouseup', handleMouseUp)\n  editor.view.container.addEventListener('mouseout', handleMouseUp)\n  editor.view.container.addEventListener('mousemove', handleMouseMove)\n\n  editor.on('destroy', () => {\n    editor.view.container.removeChild(selectionArea)\n\n\n    editor.view.container.removeEventListener('mousedown', handleMouseDown)\n    editor.view.container.removeEventListener('mouseup', handleMouseUp)\n    editor.view.container.removeEventListener('mouseout', handleMouseUp)\n    editor.view.container.removeEventListener('mousemove', handleMouseMove)\n  })\n\n  editor.on('multiselection', enabled => {\n    cfg.enabled = enabled\n  })\n\n  editor.on('keydown', (e) => {\n    if (e.ctrlKey) {\n      accumulate = true\n      editor.view.container.classList.add(\"multi-select\")\n    }\n  })\n\n  editor.on('keyup', () => {\n    if (accumulate) {\n      accumulate = false\n      editor.view.container.classList.remove(\"multi-select\")\n    }\n  })\n\n  editor.on('translate', () => {\n    return !accumulate\n  })\n  // #endregion\n}\n\nexport default {\n  name: 'rete-selection-plugin',\n  install\n}\n"],"names":["cleanSelectionArea","area","style","left","top","width","height","opacity","applyTransform","translateX","translateY","scale","position","x","y","name","install","editor","params","bind","cfg","accumulate","pressing","selection","canvas","view","container","firstElementChild","selectionArea","document","createElement","handleMouseDown","e","enabled","button","ctrlKey","selected","list","length","pointerEvents","Array","from","querySelectorAll","forEach","item","offsetX","offsetY","handleMouseUp","selectedNodes","num","transform","k","areaStart","areaEnd","nodes","filter","getNodesFromSelectionArea","node","selectNode","handleMouseMove","size","Math","abs","classList","add","boxSizing","className","_cfg$selectionArea","split","backgroundColor","border","borderRadius","appendChild","addEventListener","on","removeChild","removeEventListener","remove"],"mappings":"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"}